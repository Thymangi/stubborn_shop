{# templates/product/show.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ product.name }}{% endblock %}

{% block body %}
<div class="container py-4">

  {# Flashes après ajout/erreur #}
  {% for label, messages in app.flashes %}
    {% for m in messages %}
      <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
        {{ m }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endfor %}

  <div class="row g-4 justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card shadow-sm">
        <div class="row g-4 align-items-start p-3 p-md-4">

          <div class="col-12 col-md-7">
            <div class="ratio ratio-1x1 bg-light rounded">
              <img src="{{ asset(product.image ?? 'assets/img/placeholder.png') }}"
                   class="object-fit-contain p-3" alt="{{ product.name }}">
            </div>
          </div>

          <div class="col-12 col-md-5">
            <h1 class="h4 fw-bold mb-1">{{ product.name }}</h1>
            <div class="h4 text-primary fw-bold mb-3">
              {{ product.price|number_format(2, ',', ' ') }} €
            </div>

            <form method="post"
                  action="{{ path('cart_add', { id: product.id }) }}"
                  class="vstack gap-3 add-to-cart-form">

              <div>
                <label for="size" class="form-label fw-semibold">Taille</label>
                <select name="size" id="size" class="form-select" required>
                  <option value="" selected disabled>Choisir la taille</option>
                  {% if (product.sizeS ?? 0) > 0 %}<option value="S">S ({{ product.sizeS }} dispo)</option>{% endif %}
                  {% if (product.sizeM ?? 0) > 0 %}<option value="M">M ({{ product.sizeM }} dispo)</option>{% endif %}
                  {% if (product.sizeL ?? 0) > 0 %}<option value="L">L ({{ product.sizeL }} dispo)</option>{% endif %}
                  {% if (product.sizeXl ?? 0) > 0 %}<option value="XL">XL ({{ product.sizeXl }} dispo)</option>{% endif %}
                </select>
              </div>

              <div class="d-flex align-items-center gap-2">
                <input type="number" name="quantity" min="1" step="1" value="1"
                       class="form-control" style="max-width:120px" required>
              </div>

              <button type="submit" class="btn btn-primary btn-lg">
                Ajouter au panier
              </button>
            </form>

            <script>
              // petite validation immédiate avant envoi
              document.addEventListener('submit', function (e) {
                const f = e.target.closest('.add-to-cart-form');
                if (!f) return;

                f.querySelector('.add-error')?.remove();
                const size = f.querySelector('select[name="size"]');
                const qty  = f.querySelector('input[name="quantity"]');

                let msg = '';
                if (!size.value) msg = 'Choisis une taille.';
                else if (!qty.value || +qty.value < 1) msg = 'Quantité invalide.';

                if (msg) {
                  e.preventDefault();
                  const div = document.createElement('div');
                  div.className = 'add-error text-danger small';
                  div.textContent = msg;
                  f.appendChild(div);
                  (size.value ? qty : size).focus();
                }
              }, false);
            </script>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}